import scrapy
import utils
from datetime import datetime, timedelta


def serialize_date(value):
    """
    Serialize the string date to a datetime value.
    :param value:
    :return:
    """
    return datetime.strptime(value, '%d %b %Y')


class PivotalSpider(scrapy.Spider):
    utils.init_datadog()

    name = "pivotal_security"
    start_urls = ['https://pivotal.io/security']

    def parse(self, response):
        rows = response.css('table tr')
        entries = 0

        if len(rows) <= 0:
            utils.Report.warning('There are no rows to go through... Perhaps the syntax has changed?')

        for cve in rows:
            fields = cve.css('td')

            try:
                date = serialize_date(utils.get_string(fields[0].css('::text').extract()))
            except ValueError:
                continue

            reference = utils.get_string(fields[2].css('a ::text').extract())
            url = utils.get_string(fields[2].xpath('a//@href').extract())
            description = utils.get_string(fields[4].css('::text').extract())

            if len(reference) > 0 and len(url) > 0:
                entries += 1
            else:
                print('Invalid CVE has been detected.')
                continue

            # Check if the leak has been published in a time window.
            if utils.start_date() <= date:
                leak = {
                    'date': date,
                    'reference': reference,
                    'url': 'https://pivotal.io' + url,
                    'description': description
                }

                if not utils.event_exists(leak['reference']):
                    print('Adding new CVE event. {}'.format(leak['reference']))
                    utils.send_event('pivotal', leak)
                else:
                    print('CVE {} already registered. Skipping.'.format(leak['reference']))

        if entries <= 0:
            print('There has been an issue parsing the page.')
            utils.Report.critical('No entries could be detected! Please have a manual check instead.')
