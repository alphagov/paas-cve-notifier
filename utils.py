import config
import os
import time
from datadog import initialize, api
from datadog.api.constants import CheckStatus
from datetime import datetime, date, timedelta
from datetime import time as datetime_time


def get_string(item):
    """
    Parse an item, as a string.
    We might get different results.
    :param item:
    :return:
    """
    if isinstance(item, list):
        if len(item) > 0:
            return item[0].strip()
        else:
            return ''
    else:
        return item.strip()


def init_datadog():
    """
    Initialise the datadog instance.
    :return:
    """
    options = {
        'api_key': os.environ['DD_API_KEY'],
        'app_key': os.environ['DD_APP_KEY']
    }

    initialize(**options)


def start_date():
    """
    Calculate the starting date based on configured days.
    :return:
    """
    return midnight(datetime.today() - timedelta(days=config.TIME_WINDOW_DAYS))


def timestamp(value):
    """
    Convert datetime object to timestamp.
    :param value:
    :return:
    """
    return (value - datetime.fromtimestamp(0)).total_seconds()


def midnight(value):
    """
    Get dates start of the day.
    :param value:
    :return:
    """
    return datetime.combine(value, datetime_time.min)


def event_exists(reference):
    """
    Check if the event exists in the Datadog database.
    :param reference:
    :return:
    """
    start_time = timestamp(start_date())
    end_time = time.time()

    tag = 'security_reference:{}'.format(reference.lower())
    events = api.Event.query(start=start_time, end=end_time, tags=[tag])['events']

    return len(events) > 0


def send_event(service, security_event):
    """
    Send a new event to Datadog.
    :param service:
    :param security_event:
    :return:
    """
    reference = security_event['reference']
    text = security_event['description'] + "\n\n" + security_event['url']
    tags = [
        'security_reference:{}'.format(reference.lower()),
        'service:{}'.format(service),
        'deployment:{}'.format(os.environ['DEPLOY_ENV']),
    ]

    api.Event.create(title=reference, text=text, tags=tags)


def report_health(status, message):
    """
    Send a custom check to the Datadog, defining the app is still up and running.
    :return:
    """
    init_datadog()

    check = 'cve.notifier.ok'
    host = 'cve-notifier-{}'.format(os.environ['DEPLOY_ENV'])
    tags = [
        'deployment:{}'.format(os.environ['DEPLOY_ENV']),
    ]

    api.ServiceCheck.check(check=check, host_name=host, status=status, message=message, tags=tags)


class Report(object):
    @staticmethod
    def critical(message="Critical"):
        report_health(CheckStatus.CRITICAL, message)

    @staticmethod
    def ok(message="OK"):
        report_health(CheckStatus.OK, message)

    @staticmethod
    def warning(message="Warning"):
        report_health(CheckStatus.WARNING, message)
